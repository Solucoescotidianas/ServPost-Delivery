<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlotaControl PRO</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#b45309">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-24 font-sans text-slate-900">

    <header class="bg-amber-700 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div>
            <h1 class="font-black italic text-xl">FLOTA CONTROL</h1>
            <span class="text-[10px] bg-amber-900 px-2 py-0.5 rounded uppercase tracking-wider">Auditor√≠a en Tiempo Real</span>
        </div>
        <div id="status-gps" class="text-[10px] text-green-300 font-bold">‚óè GPS ACTIVO</div>
    </header>

    <main class="p-4 space-y-4">
        
        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
            <h2 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">Paso 1: Identificaci√≥n</h2>
            
            <div class="flex gap-3 mb-4">
                <input type="text" id="orderId" placeholder="ID Pedido (#823)" class="flex-1 p-4 bg-slate-100 border-none rounded-2xl text-lg font-bold focus:ring-2 focus:ring-amber-500">
                <label class="bg-slate-800 text-white p-4 rounded-2xl cursor-pointer active:scale-95 transition-transform">
                    üì∏ <input type="file" accept="image/*" capture="camera" class="hidden" onchange="previewPhoto(event)">
                </label>
            </div>
            
            <div id="photo-preview" class="hidden mb-4 relative">
                <img id="img-captured" src="" class="w-full h-32 object-cover rounded-xl border">
                <span class="absolute top-2 right-2 bg-green-500 text-white text-[10px] px-2 py-1 rounded-full font-bold uppercase shadow-lg">Foto Guardada</span>
            </div>

            <input type="text" id="address" placeholder="Direcci√≥n de entrega" class="w-full p-4 bg-slate-100 border-none rounded-2xl text-sm mb-3">
            
            <button onclick="openWaze()" class="w-full bg-blue-50 text-blue-700 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 active:bg-blue-100">
                üöó Abrir Navegador GPS
            </button>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
            <h2 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">Paso 2: Tiempos BK</h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="record('arrival')" id="btn-arrival" class="bg-indigo-600 text-white p-5 rounded-2xl font-black text-sm shadow-lg shadow-indigo-100 active:scale-95">LLEGADA<br>LOCAL</button>
                <button onclick="record('pickup')" id="btn-pickup" class="bg-emerald-600 text-white p-5 rounded-2xl font-black text-sm shadow-lg shadow-emerald-100 active:scale-95">RECOGIDA<br>PEDIDO</button>
            </div>
            <div id="timer-display" class="mt-4 text-center text-slate-500 font-mono text-sm">Esperando inicio...</div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
            <h2 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">Paso 3: Cobro y Cambio</h2>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="number" id="price" placeholder="Precio" class="w-1/2 p-4 bg-slate-100 border-none rounded-2xl font-bold">
                    <input type="number" id="received" placeholder="Paga con" oninput="calc()" class="w-1/2 p-4 bg-slate-100 border-none rounded-2xl font-bold">
                </div>
                <div id="change-display" class="hidden p-4 bg-amber-50 rounded-2xl text-center">
                    <span class="text-[10px] text-amber-600 font-bold uppercase block">Cambio a devolver</span>
                    <span id="change-val" class="text-3xl font-black text-amber-700">0.00‚Ç¨</span>
                </div>
                <button onclick="logIncident('Falta de cambio en BK')" class="w-full text-[10px] text-slate-400 uppercase font-bold text-center underline">¬øBK no te dio cambio?</button>
            </div>
        </div>

    </main>

    <footer class="fixed bottom-0 w-full bg-white border-t border-slate-200 p-4 flex gap-4 shadow-2xl">
        <button onclick="exportData()" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-bold text-xs uppercase tracking-widest active:scale-95">Descargar Reporte</button>
        <button onclick="location.reload()" class="bg-slate-100 p-4 rounded-2xl active:rotate-180 transition-transform">üîÑ</button>
    </footer>

    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        let session = { id: '', addr: '', in: null, out: null, photo: false, incidents: [] };
        let history = JSON.parse(localStorage.getItem('logs')) || [];

        function previewPhoto(e) {
            const reader = new FileReader();
            reader.onload = () => {
                document.getElementById('img-captured').src = reader.result;
                document.getElementById('photo-preview').classList.remove('hidden');
                session.photo = true;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function record(type) {
            const id = document.getElementById('orderId').value;
            if(!id) return alert("Escribe el ID del pedido");
            const now = new Date();

            if(type === 'arrival') {
                session.id = id;
                session.addr = document.getElementById('address').value;
                session.in = now.getTime();
                document.getElementById('timer-display').innerText = "Llegada: " + now.toLocaleTimeString();
                document.getElementById('btn-arrival').classList.add('opacity-50');
            } else {
                if(!session.in) return alert("Primero marca LLEGADA");
                session.out = now.getTime();
                const diff = Math.round((session.out - session.in) / 60000);
                document.getElementById('timer-display').innerText = "¬°Listo! Espera de " + diff + " min";
                
                history.push({ ...session, wait: diff, date: now.toLocaleDateString() });
                localStorage.setItem('logs', JSON.stringify(history));
                alert("Pedido guardado en el reporte");
            }
        }

        function calc() {
            const p = parseFloat(document.getElementById('price').value) || 0;
            const r = parseFloat(document.getElementById('received').value) || 0;
            if(r > 0) {
                document.getElementById('change-display').classList.remove('hidden');
                document.getElementById('change-val').innerText = (r - p).toFixed(2) + "‚Ç¨";
            }
        }

        function openWaze() {
            const addr = document.getElementById('address').value;
            if(addr) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`, '_blank');
        }

        function logIncident(msg) {
            session.incidents.push(msg);
            alert("Incidencia anotada: " + msg);
        }

        function exportData() {
            let csv = "ID;Fecha;Entrada;Salida;Espera(Min);Direccion;Incidencias\n";
            history.forEach(l => {
                csv += `${l.id};${l.date};${new Date(l.in).toLocaleTimeString()};${new Date(l.out).toLocaleTimeString()};${l.wait};${l.addr};${l.incidents.join("-")}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria_flota.csv`;
            a.click();
        }
    </script>
</body>
</html>
