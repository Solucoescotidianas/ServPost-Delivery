<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Servipost Auditor OCR</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; }
        .pedido-card { background: #111; border-left: 4px solid #16a34a; }
        .scanning { animation: pulse 1.5s infinite; color: #fbbf24; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen pb-32">

    <header class="bg-black border-b border-zinc-800 p-4 sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <img src="icon-512.png" class="h-10 w-10 rounded shadow-lg border border-zinc-700">
            <h1 class="text-green-500 font-black italic text-sm">SERVIPOST PRO</h1>
        </div>
        <button onclick="shareWhatsApp()" class="bg-green-600 text-[10px] px-4 py-2 rounded-full font-bold">REPORTE</button>
    </header>

    <main class="p-4 space-y-4">
        <div id="active-slots" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

        <button onclick="addNewOrder()" id="btn-add" class="w-full bg-zinc-900 border-2 border-dashed border-zinc-800 text-zinc-500 py-4 rounded-3xl font-bold">
            + Nuevo Pedido (OCR Activo)
        </button>

        <div id="history-list" class="space-y-2 mt-6"></div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('servipost_v5')) || [];
        let slots = [];

        function addNewOrder() {
            if (slots.length >= 6) return alert("MÃ¡ximo 6 pedidos");
            const uid = Date.now();
            slots.push({ uid, orderId: '', addr: '', timeIn: null, timeExit: null, timeEnd: null, price: 0, received: 0 });
            renderSlots();
        }

        async function processOCR(event, uid) {
            const file = event.target.files[0];
            const statusLabel = document.getElementById(`status-${uid}`);
            statusLabel.innerText = "Leyendo ticket...";
            statusLabel.classList.add('scanning');

            try {
                const { data: { text } } = await Tesseract.recognize(file, 'spa');
                
                // Buscar ID (Ej: #123 o nÃºmero de 3-4 cifras)
                const idMatch = text.match(/#\s?(\d+)/) || text.match(/\d{3,4}/);
                // Buscar DirecciÃ³n (Palabras clave comunes en tickets)
                const addrMatch = text.match(/(Calle|Av|C\/|Plaza|Pje)\s.+/i);

                if (idMatch) {
                    const id = idMatch[0].replace(/\s/g, '');
                    document.getElementById(`id-${uid}`).value = id;
                    updateData(uid, 'orderId', id);
                }
                if (addrMatch) {
                    const addr = addrMatch[0].substring(0, 30);
                    document.getElementById(`addr-${uid}`).value = addr;
                    updateData(uid, 'addr', addr);
                }

                statusLabel.innerText = "Escaneo completado";
                statusLabel.classList.remove('scanning');
            } catch (e) {
                statusLabel.innerText = "Error OCR - Introduce manual";
                statusLabel.classList.remove('scanning');
            }
        }

        function renderSlots() {
            const container = document.getElementById('active-slots');
            container.innerHTML = slots.map(s => `
                <div class="pedido-card p-4 rounded-3xl shadow-2xl space-y-3">
                    <div class="flex justify-between items-center">
                        <span id="status-${s.uid}" class="text-[8px] font-bold text-zinc-500 uppercase">Esperando Foto</span>
                        <button onclick="deleteSlot(${s.uid})" class="text-zinc-600">âœ•</button>
                    </div>

                    <div class="flex gap-2">
                        <label class="bg-zinc-800 p-3 rounded-2xl cursor-pointer active:bg-zinc-700">
                            ðŸ“¸ <input type="file" accept="image/*" capture="camera" class="hidden" onchange="processOCR(event, ${s.uid})">
                        </label>
                        <input type="text" id="id-${s.uid}" value="${s.orderId}" placeholder="# ID" oninput="updateData(${s.uid}, 'orderId', this.value)" class="flex-1 bg-zinc-800 p-3 rounded-2xl text-lg font-bold text-green-500 outline-none">
                    </div>

                    <input type="text" id="addr-${s.uid}" value="${s.addr}" placeholder="DirecciÃ³n detectada" oninput="updateData(${s.uid}, 'addr', this.value)" class="w-full bg-zinc-800 p-2 rounded-xl text-xs text-zinc-400">

                    <div class="grid grid-cols-3 gap-1">
                        <button onclick="captureTime(${s.uid}, 'in')" class="bg-indigo-600 py-3 rounded-xl text-[9px] font-black uppercase">Llegada</button>
                        <button onclick="captureTime(${s.uid}, 'exit')" class="bg-amber-600 py-3 rounded-xl text-[9px] font-black uppercase">Reparto</button>
                        <button onclick="captureTime(${s.uid}, 'end')" class="bg-green-600 py-3 rounded-xl text-[9px] font-black uppercase">Entrega</button>
                    </div>

                    <div class="bg-zinc-900 p-2 rounded-xl flex gap-2 items-center">
                        <input type="number" placeholder="Coste" oninput="updateCalc(${s.uid}, 'price', this.value)" class="w-1/2 bg-zinc-800 p-1 rounded text-center text-xs">
                        <input type="number" placeholder="Paga" oninput="updateCalc(${s.uid}, 'received', this.value)" class="w-1/2 bg-zinc-800 p-1 rounded text-center text-xs">
                        <span id="change-${s.uid}" class="w-full text-center text-amber-500 font-bold text-sm">0.00â‚¬</span>
                    </div>
                </div>
            `).join('');
        }

        function captureTime(uid, type) {
            const s = slots.find(x => x.uid === uid);
            const now = Date.now();
            if (type === 'in') s.timeIn = now;
            else if (type === 'exit') s.timeExit = now;
            else if (type === 'end') {
                if (!s.timeExit) return alert("Faltan pasos");
                const wait = Math.round((s.timeExit - s.timeIn) / 60000);
                const drive = Math.round((Date.now() - s.timeExit) / 60000);
                db.push({ id: s.orderId, wait, drive, total: wait+drive, time: new Date().toLocaleTimeString() });
                localStorage.setItem('servipost_v5', JSON.stringify(db));
                deleteSlot(uid);
                renderHistory();
            }
        }

        function updateData(uid, field, val) { const s = slots.find(x => x.uid === uid); if(s) s[field] = val; }
        function updateCalc(uid, field, val) {
            const s = slots.find(x => x.uid === uid);
            s[field] = parseFloat(val) || 0;
            const change = s.received - s.price;
            document.getElementById(`change-${uid}`).innerText = (change > 0 ? change.toFixed(2) : "0.00") + "â‚¬";
        }
        function deleteSlot(uid) { slots = slots.filter(s => s.uid !== uid); renderSlots(); }
        function renderHistory() {
            document.getElementById('history-list').innerHTML = db.slice(-10).reverse().map(o => `
                <div class="bg-zinc-900 p-3 rounded-2xl flex justify-between text-[10px] border border-zinc-800">
                    <span class="font-bold text-green-500">${o.id}</span>
                    <span>BK: ${o.wait}m | MOTO: ${o.drive}m</span>
                    <span class="text-zinc-500">${o.time}</span>
                </div>
            `).join('');
        }
        function shareWhatsApp() {
            let t = "*SERVIPOST REPORT*%0A";
            db.forEach(o => t += `${o.id}: BK ${o.wait}m | Moto ${o.drive}m%0A`);
            window.open(`https://wa.me/?text=${t}`);
        }
        renderHistory();
    </script>
</body>
</html>
