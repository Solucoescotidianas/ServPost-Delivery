<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Servipost Delivery Control</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #fff; }
        .pedido-card { background: #111; border-left: 4px solid #16a34a; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen pb-32">

    <header class="bg-black border-b border-zinc-800 p-4 sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <img src="icon-512.png" class="h-10 w-10 rounded shadow-lg border border-zinc-700">
            <div>
                <h1 class="text-green-500 font-black italic text-sm tracking-tighter">SERVIPOST</h1>
                <p class="text-[9px] text-zinc-500 uppercase font-bold tracking-widest">Calculadora & Tiempos</p>
            </div>
        </div>
        <button onclick="shareWhatsApp()" class="bg-green-600 text-[10px] px-3 py-1 rounded-full font-bold">ENVIAR REPORTE</button>
    </header>

    <main class="p-4 space-y-6">
        
        <div id="active-slots" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>

        <button onclick="addNewOrder()" id="btn-add" class="w-full bg-zinc-900 border-2 border-dashed border-zinc-700 text-zinc-400 py-4 rounded-2xl font-bold">
            + Añadir Pedido Simultáneo
        </button>

        <div id="history" class="space-y-2 mt-8">
            <h3 class="text-zinc-500 text-[10px] uppercase font-black tracking-widest mb-3">Historial de Hoy</h3>
        </div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('servipost_v3')) || [];
        let slots = [];

        function addNewOrder() {
            if (slots.length >= 6) return alert("Máximo 6 pedidos");
            const id = Date.now();
            slots.push({ uid: id, orderId: '', price: 0, received: 0, timeIn: null });
            renderSlots();
        }

        function renderSlots() {
            const container = document.getElementById('active-slots');
            container.innerHTML = slots.map(s => `
                <div class="pedido-card p-4 rounded-3xl shadow-2xl space-y-4">
                    <div class="flex gap-2">
                        <input type="text" placeholder="# ID" oninput="updateData(${s.uid}, 'orderId', this.value)" class="w-1/2 bg-zinc-800 p-3 rounded-xl text-lg font-bold text-green-500 outline-none">
                        <button onclick="deleteSlot(${s.uid})" class="w-1/2 text-zinc-600 text-right pr-2">Cerrar ✕</button>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="captureTime(${s.uid}, 'in')" class="bg-indigo-600 py-3 rounded-xl text-[10px] font-black uppercase">Llegada BK</button>
                        <button onclick="captureTime(${s.uid}, 'out')" class="bg-green-600 py-3 rounded-xl text-[10px] font-black uppercase">Finalizar</button>
                    </div>

                    <div class="bg-zinc-900/50 p-3 rounded-2xl border border-zinc-800">
                        <div class="flex gap-2 mb-2">
                            <input type="number" placeholder="Coste €" oninput="updateCalc(${s.uid}, 'price', this.value)" class="w-1/2 bg-zinc-800 p-2 rounded-lg text-sm">
                            <input type="number" placeholder="Paga con €" oninput="updateCalc(${s.uid}, 'received', this.value)" class="w-1/2 bg-zinc-800 p-2 rounded-lg text-sm">
                        </div>
                        <div class="text-center">
                            <span class="text-[10px] text-zinc-500 uppercase font-bold">Cambio a devolver:</span>
                            <div id="change-${s.uid}" class="text-xl font-black text-amber-500">0.00€</div>
                        </div>
                    </div>

                    <button onclick="logIncident('BK SIN CAMBIO')" class="w-full py-1 border border-red-900/30 text-red-500 text-[8px] font-bold rounded-lg uppercase">⚠️ BK No proporcionó cambio</button>
                </div>
            `).join('');
        }

        function updateCalc(uid, field, value) {
            const slot = slots.find(s => s.uid === uid);
            slot[field] = parseFloat(value) || 0;
            const change = slot.received - slot.price;
            document.getElementById(`change-${uid}`).innerText = (change > 0 ? change.toFixed(2) : "0.00") + "€";
        }

        function captureTime(uid, type) {
            const slot = slots.find(s => s.uid === uid);
            if (type === 'in') {
                slot.timeIn = new Date().getTime();
                alert("Tiempo de espera iniciado");
            } else {
                if (!slot.timeIn) return alert("Marca llegada primero");
                const wait = Math.round((new Date().getTime() - slot.timeIn) / 60000);
                db.push({ id: slot.orderId, wait: wait, price: slot.price, date: new Date().toLocaleTimeString() });
                localStorage.setItem('servipost_v3', JSON.stringify(db));
                deleteSlot(uid);
                renderHistory();
            }
        }

        function shareWhatsApp() {
            let text = "*REPORTE SERVIPOST - " + new Date().toLocaleDateString() + "*%0A%0A";
            db.forEach(o => { text += `Pedido: ${o.id} | Espera: ${o.wait} min | Total: ${o.price}€%0A`; });
            window.open(`https://wa.me/?text=${text}`);
        }

        function renderHistory() {
            const h = document.getElementById('history');
            h.innerHTML = '<h3 class="text-zinc-500 text-[10px] uppercase font-black mb-3">Historial</h3>' + 
            db.slice(-5).map(o => `<div class="bg-zinc-900 p-3 rounded-xl flex justify-between text-xs border border-zinc-800 mb-2"><span>${o.id}</span><span class="text-green-500">${o.wait} min</span></div>`).join('');
        }

        function deleteSlot(uid) { slots = slots.filter(s => s.uid !== uid); renderSlots(); }
        function updateData(uid, field, val) { const s = slots.find(x => x.uid === uid); if(s) s[field] = val; }
        function logIncident(m) { alert("Registrado: " + m); }
        
        renderHistory();
    </script>
</body>
</html>
