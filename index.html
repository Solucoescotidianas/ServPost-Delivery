<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Servipost Auditor PRO</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; }
        .pedido-card { background: #111; border-left: 4px solid #16a34a; transition: all 0.3s; }
        .btn-status { font-size: 9px; font-weight: 900; text-transform: uppercase; padding: 12px 4px; border-radius: 12px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen pb-32">

    <header class="bg-black border-b border-zinc-800 p-4 sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <img src="icon-512.png" class="h-10 w-10 rounded shadow-lg border border-zinc-700">
            <div>
                <h1 class="text-green-500 font-black italic text-sm">SERVIPOST</h1>
                <p class="text-[8px] text-zinc-500 uppercase font-bold tracking-tighter">AuditorÃ­a de Tiempos Dual</p>
            </div>
        </div>
        <button onclick="shareWhatsApp()" class="bg-green-600 text-[10px] px-4 py-2 rounded-full font-bold shadow-lg shadow-green-900/20">ENVIAR REPORTE</button>
    </header>

    <main class="p-4 space-y-6">
        
        <div id="active-slots" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>

        <button onclick="addNewOrder()" id="btn-add" class="w-full bg-zinc-900 border-2 border-dashed border-zinc-800 text-zinc-500 py-5 rounded-3xl font-bold active:scale-95 transition">
            + AÃ±adir Pedido (Hasta 6)
        </button>

        <div id="history-container" class="mt-8">
            <h3 class="text-zinc-500 text-[10px] uppercase font-black tracking-widest mb-4">Pedidos Finalizados (Hoy)</h3>
            <div id="history-list" class="space-y-3"></div>
        </div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('servipost_v4')) || [];
        let slots = [];

        function addNewOrder() {
            if (slots.length >= 6) return alert("MÃ¡ximo 6 simultÃ¡neos");
            const id = Date.now();
            slots.push({ 
                uid: id, 
                orderId: '', 
                timeIn: null,    // Llegada a BK
                timeExit: null,  // Salida a reparto
                timeEnd: null,   // Entregado
                price: 0, 
                received: 0 
            });
            renderSlots();
        }

        function renderSlots() {
            const container = document.getElementById('active-slots');
            container.innerHTML = slots.map(s => `
                <div class="pedido-card p-5 rounded-3xl shadow-2xl space-y-4 border border-zinc-800/50">
                    <div class="flex justify-between items-center">
                        <input type="text" placeholder="# ID" oninput="updateData(${s.uid}, 'orderId', this.value)" class="w-24 bg-zinc-800 p-2 rounded-xl text-lg font-black text-green-500 outline-none">
                        <button onclick="deleteSlot(${s.uid})" class="text-zinc-600 p-2">âœ•</button>
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="captureTime(${s.uid}, 'in')" class="btn-status bg-indigo-600 ${s.timeIn ? 'opacity-30' : ''}">1. Llegada</button>
                        <button onclick="captureTime(${s.uid}, 'exit')" class="btn-status bg-amber-600 ${s.timeExit ? 'opacity-30' : ''}">2. Reparto</button>
                        <button onclick="captureTime(${s.uid}, 'end')" class="btn-status bg-green-600">3. Entrega</button>
                    </div>

                    <div class="flex justify-between text-[10px] text-zinc-500 font-mono">
                        <span>Espera: <b id="wait-${s.uid}" class="text-white">0m</b></span>
                        <span>Moto: <b id="drive-${s.uid}" class="text-white">0m</b></span>
                    </div>

                    <div class="bg-zinc-900/80 p-3 rounded-2xl border border-zinc-800">
                        <div class="flex gap-2 mb-2">
                            <input type="number" placeholder="Coste" oninput="updateCalc(${s.uid}, 'price', this.value)" class="w-1/2 bg-zinc-800 p-2 rounded-lg text-sm font-bold text-center">
                            <input type="number" placeholder="Paga con" oninput="updateCalc(${s.uid}, 'received', this.value)" class="w-1/2 bg-zinc-800 p-2 rounded-lg text-sm font-bold text-center">
                        </div>
                        <div class="text-center">
                            <span id="change-${s.uid}" class="text-lg font-black text-amber-500">Cambio: 0.00â‚¬</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function captureTime(uid, type) {
            const slot = slots.find(s => s.uid === uid);
            const now = new Date().getTime();

            if (type === 'in') {
                slot.timeIn = now;
                alert("CronÃ³metro de espera BK iniciado");
            } else if (type === 'exit') {
                if (!slot.timeIn) return alert("Marca primero LLEGADA");
                slot.timeExit = now;
                alert("Saliendo a reparto. Tiempo de espera detenido.");
            } else if (type === 'end') {
                if (!slot.timeExit) return alert("Marca primero SALIDA A REPARTO");
                slot.timeEnd = now;
                
                const waitTime = Math.round((slot.timeExit - slot.timeIn) / 60000);
                const driveTime = Math.round((slot.timeEnd - slot.timeExit) / 60000);
                
                db.push({
                    id: slot.orderId || 'S/ID',
                    wait: waitTime,
                    drive: driveTime,
                    total: waitTime + driveTime,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                
                localStorage.setItem('servipost_v4', JSON.stringify(db));
                deleteSlot(uid);
                renderHistory();
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = db.slice(-15).reverse().map(o => `
                <div class="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl flex justify-between items-center">
                    <div>
                        <div class="font-black text-green-500 text-sm">${o.id}</div>
                        <div class="text-[9px] text-zinc-500">${o.time}</div>
                    </div>
                    <div class="flex gap-4 text-center">
                        <div><p class="text-[8px] text-zinc-500 uppercase font-bold">BK</p><p class="text-xs font-black">${o.wait}m</p></div>
                        <div><p class="text-[8px] text-zinc-500 uppercase font-bold">MOTO</p><p class="text-xs font-black text-indigo-400">${o.drive}m</p></div>
                        <div><p class="text-[8px] text-zinc-500 uppercase font-bold">TOTAL</p><p class="text-xs font-black text-white">${o.total}m</p></div>
                    </div>
                </div>
            `).join('');
        }

        function shareWhatsApp() {
            let text = "*AUDITORÃA SERVIPOST* ðŸ›µ%0A%0A";
            db.forEach(o => { text += `Pedido ${o.id}: BK ${o.wait}min | Moto ${o.drive}min | Total ${o.total}min%0A`; });
            window.open(`https://wa.me/?text=${text}`);
        }

        // Helpers
        function updateData(uid, field, val) { const s = slots.find(x => x.uid === uid); if(s) s[field] = val; }
        function updateCalc(uid, field, value) {
            const slot = slots.find(s => s.uid === uid);
            slot[field] = parseFloat(value) || 0;
            const change = slot.received - slot.price;
            document.getElementById(`change-${uid}`).innerText = "Cambio: " + (change > 0 ? change.toFixed(2) : "0.00") + "â‚¬";
        }
        function deleteSlot(uid) { slots = slots.filter(s => s.uid !== uid); renderSlots(); }

        renderHistory();
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
